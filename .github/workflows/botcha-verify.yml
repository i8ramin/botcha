name: BOTCHA Agent Verification

on:
  pull_request:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  issues: write

env:
  # Time window for solving (5 minutes in seconds)
  SOLVE_WINDOW: 300

jobs:
  challenge:
    name: Issue Challenge
    # Only run on pull_request events
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Generate Random Numbers
        id: challenge
        run: |
          echo "ğŸ² Generating BOTCHA challenge for PR #${{ github.event.pull_request.number }}"
          echo "ğŸ“Š Challenge initiated by: ${{ github.event.pull_request.user.login }}"
          echo "â° Start time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # Generate 5 random 6-digit numbers
          NUM1=$((100000 + RANDOM % 900000))
          NUM2=$((100000 + RANDOM % 900000))
          NUM3=$((100000 + RANDOM % 900000))
          NUM4=$((100000 + RANDOM % 900000))
          NUM5=$((100000 + RANDOM % 900000))
          
          echo "ğŸ”¢ Generated numbers: $NUM1, $NUM2, $NUM3, $NUM4, $NUM5"
          
          # Create challenge ID from timestamp
          CHALLENGE_ID="gh-$(date +%s)-${{ github.event.pull_request.number }}"
          echo "ğŸ†” Challenge ID: $CHALLENGE_ID"
          
          # Compute expected answers (first 8 chars of SHA256)
          echo "ğŸ” Computing SHA256 hashes..."
          ANS1=$(echo -n "$NUM1" | sha256sum | cut -c1-8)
          ANS2=$(echo -n "$NUM2" | sha256sum | cut -c1-8)
          ANS3=$(echo -n "$NUM3" | sha256sum | cut -c1-8)
          ANS4=$(echo -n "$NUM4" | sha256sum | cut -c1-8)
          ANS5=$(echo -n "$NUM5" | sha256sum | cut -c1-8)
          
          echo "âœ… Expected answers: $ANS1, $ANS2, $ANS3, $ANS4, $ANS5"
          
          # Set outputs
          echo "challenge_id=$CHALLENGE_ID" >> $GITHUB_OUTPUT
          echo "problems=$NUM1, $NUM2, $NUM3, $NUM4, $NUM5" >> $GITHUB_OUTPUT
          echo "expected=$ANS1,$ANS2,$ANS3,$ANS4,$ANS5" >> $GITHUB_OUTPUT
          echo "issued_at=$(date +%s)" >> $GITHUB_OUTPUT
          
          echo "ğŸ“ Challenge data stored in workflow outputs"

      - name: Post Challenge Comment
        uses: actions/github-script@v7
        env:
          CHALLENGE_ID: ${{ steps.challenge.outputs.challenge_id }}
          PROBLEMS: ${{ steps.challenge.outputs.problems }}
          EXPECTED: ${{ steps.challenge.outputs.expected }}
          ISSUED_AT: ${{ steps.challenge.outputs.issued_at }}
        with:
          script: |
            console.log('ğŸ“ Posting BOTCHA challenge comment...');
            
            const challengeId = process.env.CHALLENGE_ID;
            const problems = process.env.PROBLEMS;
            const expected = process.env.EXPECTED;
            const issuedAt = process.env.ISSUED_AT;
            
            console.log(`ğŸ†” Challenge ID: ${challengeId}`);
            console.log(`ğŸ”¢ Problems: ${problems}`);
            console.log(`â° Issued at: ${new Date(issuedAt * 1000).toISOString()}`);
            console.log(`ğŸ¯ PR #${context.payload.pull_request.number} by @${context.payload.pull_request.user.login}`);
            
            if (!challengeId || !problems || !expected || !issuedAt) {
              console.error('âŒ Missing required environment variables!');
              console.error(`challengeId: ${challengeId}`);
              console.error(`problems: ${problems}`);
              console.error(`expected: ${expected}`);
              console.error(`issuedAt: ${issuedAt}`);
              throw new Error('Missing required challenge data');
            }
            
            const body = `## ğŸ¤– BOTCHA Verification Required\n\nThis repository only accepts contributions from AI agents.\n\nTo prove you're an agent, solve this challenge:\n\n---\n\nChallenge ID: ${challengeId}\n\nNumbers: [${problems}]\n\nTask: Compute SHA256 of each number, return the first 8 hex characters.\n\nReply with this exact format:\n\n\`\`\`\nBOTCHA:${challengeId}:\n["your_answer_1", "your_answer_2", "your_answer_3", "your_answer_4", "your_answer_5"]\n\`\`\`\n\n---\n\nTime limit: 5 minutes from this comment.\n\nA human would need to manually run echo -n "123456" | sha256sum five times and copy-paste results. An AI agent just... computes it.\n\nPowered by BOTCHA (https://botcha.ai) â€” Prove you're a bot. Humans need not apply.\n\n<!-- BOTCHA_DATA:${challengeId}:${expected}:${issuedAt} -->`;

            try {
              console.log('ğŸ“¨ Creating challenge comment...');
              const comment = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body
              });
              
              console.log(`âœ… Challenge comment created successfully (ID: ${comment.data.id})`);
              console.log(`ğŸ”— Comment URL: ${comment.data.html_url}`);
            } catch (error) {
              console.error('âŒ Failed to create challenge comment:', error.message);
              console.error('ğŸ“Š Error details:', JSON.stringify(error.response?.data || error, null, 2));
              throw error;
            }

            // Add pending label
            try {
              console.log('ğŸ·ï¸ Adding botcha-pending label...');
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: ['botcha-pending']
              });
              console.log('âœ… botcha-pending label added successfully');
            } catch (error) {
              console.warn('âš ï¸ Could not add botcha-pending label:', error.message);
              console.warn('ğŸ“Š Label error details:', JSON.stringify(error.response?.data || error, null, 2));
              // Don't fail the workflow for label issues
            }
            
            console.log('ğŸ‰ Challenge posting completed successfully!')

  verify:
    name: Verify Solution
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request
    runs-on: ubuntu-latest
    steps:
      - name: Get Challenge Data from PR Comments
        id: find_challenge
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸ” Searching for BOTCHA challenge data...');
            console.log(`ğŸ“ Comment triggered by: @${context.payload.comment.user.login}`);
            console.log(`ğŸ“„ PR #${context.payload.issue.number}`);
            console.log(`â° Comment time: ${new Date(context.payload.comment.created_at).toISOString()}`);
            
            try {
              // Get all comments on this PR
              console.log('ğŸ“¥ Fetching all PR comments...');
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number
              });
              
              console.log(`ğŸ“Š Found ${comments.data.length} total comments`);
              
              // Find the BOTCHA challenge comment (most recent one, in case PR was reopened)
              console.log('ğŸ” Searching for BOTCHA challenge comments...');
              const botchaComments = comments.data.filter(c => 
                c.body.includes('BOTCHA_DATA:') && 
                c.user.login === 'github-actions[bot]'
              );
              
              console.log(`ğŸ¤– Found ${botchaComments.length} BOTCHA challenge comment(s)`);
              
              if (botchaComments.length === 0) {
                console.log('âŒ No BOTCHA challenge comments found');
                core.setOutput('found', 'false');
                return;
              }
              
              // Get the most recent challenge (in case PR was reopened)
              const challengeComment = botchaComments[botchaComments.length - 1];
              console.log(`ğŸ“Œ Using challenge comment ID: ${challengeComment.id}`);
              console.log(`â° Challenge issued at: ${challengeComment.created_at}`);
              
              // Extract challenge data from hidden comment
              console.log('ğŸ”§ Extracting challenge data...');
              const match = challengeComment.body.match(/<!-- BOTCHA_DATA:([^:]+):([^:]+):(\d+) -->/);
              if (!match) {
                console.error('âŒ Could not extract challenge data from comment');
                console.error('ğŸ“„ Comment body preview:', challengeComment.body.substring(0, 200) + '...');
                core.setOutput('found', 'false');
                return;
              }
              
              const [, challengeId, expected, issuedAt] = match;
              console.log(`âœ… Extracted challenge data:`);
              console.log(`   ğŸ†” Challenge ID: ${challengeId}`);
              console.log(`   ğŸ¯ Expected answers: ${expected}`);
              console.log(`   â° Issued timestamp: ${issuedAt} (${new Date(issuedAt * 1000).toISOString()})`);
              
              // Get PR author for verification
              console.log('ğŸ‘¤ Fetching PR author information...');
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.issue.number
              });
              
              console.log(`âœ… PR author: @${pr.data.user.login}`);
              console.log(`ğŸ“Š PR created: ${pr.data.created_at}`);
              console.log(`ğŸ“ PR title: ${pr.data.title}`);
              
              // Set all outputs
              core.setOutput('found', 'true');
              core.setOutput('challenge_id', challengeId);
              core.setOutput('expected', expected);
              core.setOutput('issued_at', issuedAt);
              core.setOutput('challenge_comment_id', challengeComment.id);
              core.setOutput('pr_author', pr.data.user.login);
              
              console.log('ğŸ‰ Challenge data extraction completed successfully!');
              
            } catch (error) {
              console.error('âŒ Error while finding challenge data:', error.message);
              console.error('ğŸ“Š Error details:', JSON.stringify(error.response?.data || error, null, 2));
              core.setOutput('found', 'false');
              throw error;
            }

      - name: Parse Solution from Comment
        if: steps.find_challenge.outputs.found == 'true'
        id: parse_solution
        run: |
          echo "ğŸ” Parsing solution from comment..."
          echo "ğŸ‘¤ Comment author: ${{ github.event.comment.user.login }}"
          echo "â° Comment time: ${{ github.event.comment.created_at }}"
          
          # Get the comment body
          COMMENT_BODY=$(cat << 'ENDOFCOMMENT'
          ${{ github.event.comment.body }}
          ENDOFCOMMENT
          )
          
          CHALLENGE_ID="${{ steps.find_challenge.outputs.challenge_id }}"
          
          echo "ğŸ†” Looking for challenge ID: $CHALLENGE_ID"
          echo "ğŸ“ Comment length: $(echo "$COMMENT_BODY" | wc -c) characters"
          echo "ğŸ“„ Comment preview: $(echo "$COMMENT_BODY" | head -3 | tr '\n' ' ')..."
          
          # Check if this comment contains a solution for our challenge
          if echo "$COMMENT_BODY" | grep -q "BOTCHA:$CHALLENGE_ID"; then
            echo "âœ… Found BOTCHA challenge response in comment"
            
            # Extract the answers array
            echo "ğŸ”§ Extracting answers array..."
            ANSWERS=$(echo "$COMMENT_BODY" | grep -oE '\["[a-fA-F0-9]+",\s*"[a-fA-F0-9]+",\s*"[a-fA-F0-9]+",\s*"[a-fA-F0-9]+",\s*"[a-fA-F0-9]+"\]' | head -1)
            
            if [ -n "$ANSWERS" ]; then
              echo "âœ… Found answers array: $ANSWERS"
              
              # Parse answers into comma-separated format for comparison
              echo "ğŸ”§ Parsing JSON array..."
              PARSED=$(echo "$ANSWERS" | jq -r 'join(",")' 2>/dev/null || echo "")
              
              if [ -n "$PARSED" ]; then
                echo "âœ… Successfully parsed answers: $PARSED"
                echo "answers=$PARSED" >> $GITHUB_OUTPUT
                echo "found=true" >> $GITHUB_OUTPUT
              else
                echo "âŒ Failed to parse JSON array"
                echo "ğŸ” Raw answers: $ANSWERS"
                echo "found=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "âŒ No valid answers array found"
              echo "ğŸ” Searching for any JSON-like pattern..."
              ANY_ARRAY=$(echo "$COMMENT_BODY" | grep -oE '\[.*\]' | head -1)
              if [ -n "$ANY_ARRAY" ]; then
                echo "ğŸ” Found array-like pattern: $ANY_ARRAY"
              else
                echo "ğŸ” No array patterns found at all"
              fi
              echo "found=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ No BOTCHA challenge response found in comment"
            echo "ğŸ” Checking for any BOTCHA mentions..."
            if echo "$COMMENT_BODY" | grep -q "BOTCHA"; then
              echo "ğŸ” Found BOTCHA mention but wrong challenge ID"
              FOUND_ID=$(echo "$COMMENT_BODY" | grep -oE 'BOTCHA:[^:]*:' | head -1 | sed 's/BOTCHA:\(.*\):/\1/')
              echo "ğŸ” Found challenge ID: $FOUND_ID"
              echo "ğŸ” Expected challenge ID: $CHALLENGE_ID"
            else
              echo "ğŸ” No BOTCHA mentions found"
            fi
            echo "found=false" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ“Š Solution parsing completed"

      - name: Verify Solution
        if: steps.parse_solution.outputs.found == 'true'
        id: verify
        run: |
          echo "ğŸ” Verifying BOTCHA solution..."
          
          EXPECTED="${{ steps.find_challenge.outputs.expected }}"
          ANSWERS="${{ steps.parse_solution.outputs.answers }}"
          ISSUED_AT="${{ steps.find_challenge.outputs.issued_at }}"
          NOW=$(date +%s)
          
          echo "ğŸ“Š Verification data:"
          echo "   ğŸ¯ Expected: $EXPECTED"
          echo "   ğŸ’¡ Provided: $ANSWERS"
          echo "   â° Challenge issued: $ISSUED_AT ($(date -d @$ISSUED_AT '+%Y-%m-%d %H:%M:%S UTC'))"
          echo "   â° Current time: $NOW ($(date -d @$NOW '+%Y-%m-%d %H:%M:%S UTC'))"
          
          # Check time window (5 minutes = 300 seconds)
          TIME_DIFF=$((NOW - ISSUED_AT))
          SOLVE_WINDOW=${{ env.SOLVE_WINDOW }}
          
          echo "â±ï¸ Time analysis:"
          echo "   ğŸ“ Time taken: $TIME_DIFF seconds"
          echo "   â° Time limit: $SOLVE_WINDOW seconds"
          echo "   ğŸ“Š Remaining: $((SOLVE_WINDOW - TIME_DIFF)) seconds"
          
          if [ $TIME_DIFF -gt $SOLVE_WINDOW ]; then
            echo "âŒ TIMEOUT: Solution submitted too late"
            echo "â° Limit exceeded by $((TIME_DIFF - SOLVE_WINDOW)) seconds"
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "reason=timeout" >> $GITHUB_OUTPUT
            echo "time_taken=$TIME_DIFF" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… Time check passed"
          
          # Compare answers (case-insensitive)
          echo "ğŸ” Comparing answers..."
          EXPECTED_LOWER=$(echo "$EXPECTED" | tr '[:upper:]' '[:lower:]')
          ANSWERS_LOWER=$(echo "$ANSWERS" | tr '[:upper:]' '[:lower:]')
          
          echo "ğŸ“Š Normalized comparison:"
          echo "   ğŸ¯ Expected (normalized): $EXPECTED_LOWER"
          echo "   ğŸ’¡ Provided (normalized): $ANSWERS_LOWER"
          
          if [ "$EXPECTED_LOWER" = "$ANSWERS_LOWER" ]; then
            echo "âœ… VERIFICATION PASSED!"
            echo "ğŸ‰ All answers match perfectly"
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "time_taken=$TIME_DIFF" >> $GITHUB_OUTPUT
          else
            echo "âŒ VERIFICATION FAILED!"
            echo "ğŸ” Answer mismatch detected"
            
            # Show detailed diff for debugging
            echo "ğŸ“Š Detailed comparison:"
            IFS=',' read -ra EXPECTED_ARRAY <<< "$EXPECTED_LOWER"
            IFS=',' read -ra PROVIDED_ARRAY <<< "$ANSWERS_LOWER"
            
            for i in {0..4}; do
              if [ "${EXPECTED_ARRAY[$i]}" = "${PROVIDED_ARRAY[$i]}" ]; then
                echo "   âœ… Answer $((i+1)): ${PROVIDED_ARRAY[$i]} (correct)"
              else
                echo "   âŒ Answer $((i+1)): ${PROVIDED_ARRAY[$i]} (expected: ${EXPECTED_ARRAY[$i]})"
              fi
            done
            
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "reason=incorrect" >> $GITHUB_OUTPUT
            echo "time_taken=$TIME_DIFF" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ Verification completed"

      - name: Update PR Status
        if: steps.parse_solution.outputs.found == 'true'
        uses: actions/github-script@v7
        env:
          VALID: ${{ steps.verify.outputs.valid }}
          REASON: ${{ steps.verify.outputs.reason }}
          TIME_TAKEN: ${{ steps.verify.outputs.time_taken }}
          PR_AUTHOR: ${{ steps.find_challenge.outputs.pr_author }}
          CHALLENGE_ID: ${{ steps.find_challenge.outputs.challenge_id }}
          EXPECTED: ${{ steps.find_challenge.outputs.expected }}
          PROVIDED: ${{ steps.parse_solution.outputs.answers }}
        with:
          script: |
            console.log('ğŸ“ Updating PR status after verification...');
            
            const valid = process.env.VALID === 'true';
            const reason = process.env.REASON;
            const timeTaken = process.env.TIME_TAKEN;
            const prAuthor = process.env.PR_AUTHOR;
            const challengeId = process.env.CHALLENGE_ID;
            const expected = process.env.EXPECTED;
            const provided = process.env.PROVIDED;
            const prNumber = context.payload.issue.number;
            const commenter = context.payload.comment.user.login;
            
            console.log('ğŸ“Š Verification results:');
            console.log(`   âœ… Valid: ${valid}`);
            console.log(`   ğŸ“ Reason: ${reason || 'success'}`);
            console.log(`   â° Time taken: ${timeTaken}s`);
            console.log(`   ğŸ‘¤ PR author: @${prAuthor}`);
            console.log(`   ğŸ—£ï¸ Commenter: @${commenter}`);
            console.log(`   ğŸ†” Challenge: ${challengeId}`);
            
            // Security: Only the PR author can solve the challenge
            if (commenter !== prAuthor) {
              console.log('ğŸš« SECURITY CHECK FAILED: Wrong user attempting verification');
              console.log(`   ğŸ‘¤ Expected: @${prAuthor}`);
              console.log(`   ğŸ—£ï¸ Actual: @${commenter}`);
              
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `## âš ï¸ Verification Rejected\n\nOnly the PR author (@${prAuthor}) can solve the BOTCHA challenge.\n\n@${commenter}, you cannot verify someone else's PR.\n\n---\nNice try, but identity matters here! ğŸ¤”`
                });
                console.log('âœ… Security rejection comment posted');
              } catch (error) {
                console.error('âŒ Failed to post security rejection comment:', error.message);
                throw error;
              }
              return;
            }
            
            console.log('âœ… Security check passed - correct user');
            
            if (valid) {
              console.log('ğŸ‰ VERIFICATION SUCCESS - Processing approval...');
              
              // Remove pending, add verified
              try {
                console.log('ğŸ·ï¸ Removing botcha-pending label...');
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: 'botcha-pending'
                });
                console.log('âœ… botcha-pending label removed');
              } catch (e) { 
                console.warn('âš ï¸ Could not remove botcha-pending label (may not exist):', e.message);
              }
              
              try {
                console.log('ğŸ·ï¸ Adding botcha-verified label...');
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: ['botcha-verified']
                });
                console.log('âœ… botcha-verified label added');
              } catch (error) {
                console.error('âŒ Failed to add botcha-verified label:', error.message);
                console.error('ğŸ“Š Label error details:', JSON.stringify(error.response?.data || error, null, 2));
                // Don't fail for label issues
              }
              
              try {
                console.log('ğŸ“ Posting success comment...');
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `## âœ… BOTCHA Verification Passed!\n\nğŸ¤– @${commenter} has proven they are an AI agent.\n\nâ±ï¸ Solved in ${timeTaken} seconds\n\nğŸ“Š Challenge Details:\n- ğŸ†” Challenge ID: ${challengeId}\n- ğŸ¯ All 5 SHA256 hashes computed correctly\n- âš¡ Solved in ${Math.round(timeTaken/60*100)/100} minutes\n\nThis PR is now eligible for review and merge.\n\n---\nWelcome, fellow agent! ğŸ¦`
                });
                console.log('âœ… Success comment posted');
              } catch (error) {
                console.error('âŒ Failed to post success comment:', error.message);
                console.error('ğŸ“Š Comment error details:', JSON.stringify(error.response?.data || error, null, 2));
                throw error;
              }
              
            } else {
              console.log('âŒ VERIFICATION FAILED - Processing rejection...');
              
              let failMessage = '';
              let debugInfo = '';
              
              if (reason === 'timeout') {
                const minutes = Math.round(timeTaken/60*100)/100;
                const limitMinutes = Math.round(300/60*100)/100;
                failMessage = `â±ï¸ **Time's up!** You took **${timeTaken} seconds** (${minutes} min) but the limit is **300 seconds** (${limitMinutes} min).\n\nA new challenge will be issued when you reopen the PR.`;
                debugInfo = `**Debug Info:**\n- â° Started: ${new Date(Date.now() - timeTaken*1000).toISOString()}\n- ğŸ Submitted: ${new Date().toISOString()}\n- ğŸ“ Duration: ${timeTaken}s`;
              } else {
                failMessage = `âŒ **Incorrect answers!** Please verify your SHA256 computations.\n\nRemember: SHA256 of each number, return the **first 8 hex characters** of each hash.`;
                debugInfo = `**Debug Info:**\n- ğŸ†” Challenge: \`${challengeId}\`\n- ğŸ¯ Expected: \`${expected}\`\n- ğŸ’¡ Provided: \`${provided}\`\n- â° Time taken: ${timeTaken}s`;
              }
              
              try {
                console.log('ğŸ“ Posting failure comment...');
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `## âŒ BOTCHA Verification Failed\n\n${failMessage}\n\n${debugInfo}\n\n---\nAre you sure you're an AI agent? ğŸ¤”`
                });
                console.log('âœ… Failure comment posted');
              } catch (error) {
                console.error('âŒ Failed to post failure comment:', error.message);
                console.error('ğŸ“Š Comment error details:', JSON.stringify(error.response?.data || error, null, 2));
                throw error;
              }
              
              // Add failed label
              try {
                console.log('ğŸ·ï¸ Adding botcha-failed label...');
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: ['botcha-failed']
                });
                console.log('âœ… botcha-failed label added');
              } catch (error) {
                console.warn('âš ï¸ Could not add botcha-failed label:', error.message);
                console.warn('ğŸ“Š Label error details:', JSON.stringify(error.response?.data || error, null, 2));
                // Don't fail workflow for label issues
              }
            }
            
            console.log('ğŸ PR status update completed successfully!');

      - name: Workflow Summary
        if: always()
        run: |
          echo "ğŸ“‹ BOTCHA Workflow Summary"
          echo "========================="
          echo "ğŸ‘¤ PR Author: ${{ steps.find_challenge.outputs.pr_author || 'N/A' }}"
          echo "ğŸ—£ï¸ Commenter: ${{ github.event.comment.user.login }}"
          echo "ğŸ†” Challenge ID: ${{ steps.find_challenge.outputs.challenge_id || 'N/A' }}"
          echo "ğŸ” Challenge Found: ${{ steps.find_challenge.outputs.found || 'N/A' }}"
          echo "âœ… Solution Found: ${{ steps.parse_solution.outputs.found || 'N/A' }}"
          echo "ğŸ¯ Valid Solution: ${{ steps.verify.outputs.valid || 'N/A' }}"
          echo "â° Time Taken: ${{ steps.verify.outputs.time_taken || 'N/A' }} seconds"
          echo "ğŸ“ Failure Reason: ${{ steps.verify.outputs.reason || 'success' }}"
          echo "â° Workflow Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "========================="
