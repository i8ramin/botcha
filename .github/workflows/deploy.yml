name: Deploy BOTCHA to Cloudflare Workers

on:
  push:
    branches: [ main ]
    paths:
      - 'packages/cloudflare-workers/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: |
          cd packages/cloudflare-workers
          bun install
          
      - name: Build TypeScript
        run: |
          cd packages/cloudflare-workers
          bun run build
          
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          workingDirectory: packages/cloudflare-workers
          command: deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          
      - name: Comment deployment status
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.sha.substring(0, 7);
            const message = `ðŸš€ BOTCHA deployed to Cloudflare Workers (${sha})
            
            Test the fix:
            \`\`\`bash
            curl -X POST https://botcha.ai/api/verify-landing \\
              -H "Content-Type: application/json" \\
              -d '{"answer": "$(echo -n 'BOTCHA-LANDING-$(date +%Y-%m-%d)' | sha256sum | cut -c1-16)", "timestamp": "$(date -Iseconds)"}'
            \`\`\``;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: message
            });